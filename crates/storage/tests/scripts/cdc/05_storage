# Copyright (c) reifydb.com 2025
# This file is licensed under the AGPL-3.0-or-later, see license.md file

# Test CDC event storage and retrieval
insert 1 a=1
commit
---
ok

insert 2 b=2
commit
---
ok

update 3 a=10
commit
---
ok

delete 4 b
commit
---
ok

# Verify all events are stored
cdc_get 1 1
---
CdcEvent { version: 1, seq: 1, ts: 1000, change: Insert { key: "a", after: "1" } }

cdc_get 2 1
---
CdcEvent { version: 2, seq: 1, ts: 1000, change: Insert { key: "b", after: "2" } }

cdc_get 3 1
---
CdcEvent { version: 3, seq: 1, ts: 1000, change: Update { key: "a", before: "1", after: "10" } }

cdc_get 4 1
---
CdcEvent { version: 4, seq: 1, ts: 1000, change: Delete { key: "b", before: "2" } }

# Test non-existent CDC event retrieval
cdc_get 5 1
---
None

cdc_get 1 2
---
None

# Test CDC range query
cdc_range 1 4
---
CdcEvent { version: 1, seq: 1, ts: 1000, change: Insert { key: "a", after: "1" } }
CdcEvent { version: 2, seq: 1, ts: 1000, change: Insert { key: "b", after: "2" } }
CdcEvent { version: 3, seq: 1, ts: 1000, change: Update { key: "a", before: "1", after: "10" } }
CdcEvent { version: 4, seq: 1, ts: 1000, change: Delete { key: "b", before: "2" } }

# Test CDC scan (returns all events)
cdc_scan
---
CdcEvent { version: 1, seq: 1, ts: 1000, change: Insert { key: "a", after: "1" } }
CdcEvent { version: 2, seq: 1, ts: 1000, change: Insert { key: "b", after: "2" } }
CdcEvent { version: 3, seq: 1, ts: 1000, change: Update { key: "a", before: "1", after: "10" } }
CdcEvent { version: 4, seq: 1, ts: 1000, change: Delete { key: "b", before: "2" } }

# Test CDC count per version
cdc_count 1
---
count: 1

cdc_count 2
---
count: 1

cdc_count 3
---
count: 1

cdc_count 4
---
count: 1

cdc_count 5
---
count: 0

# Test multiple events in same version
insert 10 x=100
insert 10 y=200
update 10 x=101
commit
---
ok

cdc_count 10
---
count: 3

cdc_get 10 1
---
CdcEvent { version: 10, seq: 1, ts: 1000, change: Insert { key: "x", after: "100" } }

cdc_get 10 2
---
CdcEvent { version: 10, seq: 2, ts: 1000, change: Insert { key: "y", after: "200" } }

cdc_get 10 3
---
CdcEvent { version: 10, seq: 3, ts: 1000, change: Update { key: "x", before: "100", after: "101" } }

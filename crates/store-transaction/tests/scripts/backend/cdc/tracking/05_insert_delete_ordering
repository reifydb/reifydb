# Copyright (c) reifydb.com 2025
# This file is licensed under the AGPL-3.0-or-later, see license.md file

# Test that insert+delete only cancel when in the same transaction
# Operations in different transactions should NOT cancel

# Insert in v1, delete in v2 - should NOT cancel
insert 1 key_a=value_a
commit
---
ok

delete 2 key_a
commit
---
ok

# Both operations should appear in CDC
cdc_get 1 1
---
Change { seq: 1, change: Insert { key: "key_a", post: "value_a" } }

cdc_get 2 1
---
Change { seq: 1, change: Delete { key: "key_a", pre: "value_a" } }

# Delete then insert in different versions - should NOT cancel
insert 3 key_b=value_b
commit
---
ok

delete 4 key_b
commit
---
ok

insert 5 key_b=value_b_new
commit
---
ok

# All three operations should appear
cdc_get 3 1
---
Change { seq: 1, change: Insert { key: "key_b", post: "value_b" } }

cdc_get 4 1
---
Change { seq: 1, change: Delete { key: "key_b", pre: "value_b" } }

cdc_get 5 1
---
Change { seq: 1, change: Insert { key: "key_b", post: "value_b_new" } }

# Same key operations across transactions don't interfere
insert 6 key_c=v1
delete 6 key_c
commit
---
ok

insert 7 key_c=v2
delete 7 key_c
commit
---
ok

# Both transactions should have empty CDC (each cancels within itself)
cdc_count 6
---
count: 0

cdc_count 7
---
count: 0

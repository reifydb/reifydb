# Copyright (c) reifydb.com 2025
# This file is licensed under the AGPL-3.0-or-later, see license.md file

# Test that operations across different transactions do NOT cancel
# Each transaction's CDC is independent

# Insert in v1
insert 1 key_a=value_a
commit
---
ok

# Update in v2
update 2 key_a=value_a_updated
commit
---
ok

# Delete in v3
delete 3 key_a
commit
---
ok

# All three operations should be in CDC
cdc_get 1 1
---
Change { seq: 1, change: Insert { key: "key_a", post: "value_a" } }

cdc_get 2 1
---
Change { seq: 1, change: Update { key: "key_a", pre: "value_a", post: "value_a_updated" } }

cdc_get 3 1
---
Change { seq: 1, change: Delete { key: "key_a", pre: "value_a_updated" } }

# Same key, different pattern
insert 4 key_b=b1
commit
---
ok

# Multiple updates in v5
update 5 key_b=b2
update 5 key_b=b3
commit
---
ok

# Delete in v6
delete 6 key_b
commit
---
ok

# Each transaction has its own CDC
cdc_get 4 1
---
Change { seq: 1, change: Insert { key: "key_b", post: "b1" } }

cdc_get 5 1
---
Change { seq: 1, change: Update { key: "key_b", pre: "b1", post: "b3" } }

cdc_get 6 1
---
Change { seq: 1, change: Delete { key: "key_b", pre: "b3" } }

# Cancellation within each transaction, but not across
insert 7 key_c=c1
delete 7 key_c
commit
---
ok

insert 8 key_c=c2
delete 8 key_c
commit
---
ok

# Both transactions have empty CDC (cancelled within each)
cdc_count 7
---
count: 0

cdc_count 8
---
count: 0

# But if we don't cancel within transaction
insert 9 key_c=c3
commit
---
ok

delete 10 key_c
commit
---
ok

# Both appear in CDC
cdc_get 9 1
---
Change { seq: 1, change: Insert { key: "key_c", post: "c3" } }

cdc_get 10 1
---
Change { seq: 1, change: Delete { key: "key_c", pre: "c3" } }

# Copyright (c) reifydb.com 2025
# This file is licensed under the AGPL-3.0-or-later, see license.md file

# Test large transaction with many cancellations
# Verify proper sequence renumbering for remaining operations

# Large transaction: 20 operations, 10 cancelled
insert 1 keep_01=k01
insert 1 cancel_01=c01
insert 1 keep_02=k02
delete 1 cancel_01
insert 1 cancel_02=c02
insert 1 keep_03=k03
delete 1 cancel_02
insert 1 keep_04=k04
insert 1 cancel_03=c03
insert 1 cancel_04=c04
delete 1 cancel_03
insert 1 keep_05=k05
delete 1 cancel_04
insert 1 cancel_05=c05
insert 1 keep_06=k06
delete 1 cancel_05
insert 1 keep_07=k07
insert 1 cancel_06=c06
insert 1 keep_08=k08
delete 1 cancel_06
insert 1 cancel_07=c07
insert 1 keep_09=k09
delete 1 cancel_07
insert 1 cancel_08=c08
insert 1 keep_10=k10
delete 1 cancel_08
insert 1 cancel_09=c09
delete 1 cancel_09
insert 1 cancel_10=c10
delete 1 cancel_10
commit
---
ok

# Should have exactly 10 remaining operations
cdc_count 1
---
count: 10

# Verify first few sequences
cdc_get 1 1
---
Change { seq: 1, change: Insert { key: "keep_01", post: "k01" } }

cdc_get 1 2
---
Change { seq: 2, change: Insert { key: "keep_02", post: "k02" } }

cdc_get 1 5
---
Change { seq: 5, change: Insert { key: "keep_05", post: "k05" } }

cdc_get 1 10
---
Change { seq: 10, change: Insert { key: "keep_10", post: "k10" } }

cdc_get 1 11
---
None

# Bulk operations with selective cancellation
bulk_insert 2 20
---
ok

# Delete half of them
delete 3 bulk_0
delete 3 bulk_2
delete 3 bulk_4
delete 3 bulk_6
delete 3 bulk_8
delete 3 bulk_10
delete 3 bulk_12
delete 3 bulk_14
delete 3 bulk_16
delete 3 bulk_18
commit
---
ok

# Should have 10 deletes
cdc_count 3
---
count: 10

# Insert and delete many in same transaction
insert 4 temp_1=t1
delete 4 temp_1
insert 4 temp_2=t2
delete 4 temp_2
insert 4 temp_3=t3
delete 4 temp_3
insert 4 temp_4=t4
delete 4 temp_4
insert 4 temp_5=t5
delete 4 temp_5
insert 4 final=done
commit
---
ok

# Only final remains
cdc_get 4 1
---
Change { seq: 1, change: Insert { key: "final", post: "done" } }

cdc_count 4
---
count: 1

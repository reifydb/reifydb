# Copyright (c) reifydb.com 2025
# This file is licensed under the AGPL-3.0-or-later, see license.md file

# Test timestamp is captured at commit time
insert 1 a=1
commit
---
ok

cdc_get 1
---
Cdc { version: 1, ts: 1000, changes: [{ seq: 1, change: Insert { key: "a", post: "1" } }] }

# Advance clock and test new timestamp
advance_clock 500
insert 2 b=2
commit
---
ok
ok

cdc_get 2
---
Cdc { version: 2, ts: 1500, changes: [{ seq: 1, change: Insert { key: "b", post: "2" } }] }

# Advance clock more
advance_clock 1000
insert 3 c=3
commit
---
ok
ok

cdc_get 3
---
Cdc { version: 3, ts: 2500, changes: [{ seq: 1, change: Insert { key: "c", post: "3" } }] }

# Test multiple changes have same timestamp
advance_clock 100
insert 4 d=4
update 4 a=10
delete 4 b
commit
---
ok
ok

cdc_get 4
---
Cdc { version: 4, ts: 2600, changes: [{ seq: 1, change: Insert { key: "d", post: "4" } }, { seq: 2, change: Update { key: "a", pre: "1", post: "10" } }, { seq: 3, change: Delete { key: "b", pre: "2" } }] }

# Test timestamp continues advancing
advance_clock 5000
insert 5 e=5
commit
---
ok
ok

cdc_get 5
---
Cdc { version: 5, ts: 7600, changes: [{ seq: 1, change: Insert { key: "e", post: "5" } }] }

# Regression test for single-version semantics write/scan race
# Verifies that continuous updates with keep_last_versions=1 don't leak historical bytes
#
# Bug: When Drop delta scans storage, the new version from Set delta isn't written yet.
# Drop thinks the old version (just moved to historical) is still the latest, keeps it.
# Fix: Pass pending_version to find_keys_to_drop so it knows about the version being written.

# First update: creates initial version
set a=value1 version=1
---
ok

stats_current
---
current_count: 1
current_key_bytes: 11
current_value_bytes: 6

stats_historical
---
historical_count: 0
historical_key_bytes: 0
historical_value_bytes: 0

# Second update: should drop version 1
set a=value2 version=2
---
ok

# Explicitly drop old versions with keep_last_versions=1
drop a keep_last_versions=1 version=3
---
ok

stats_current
---
current_count: 1
current_key_bytes: 11
current_value_bytes: 6

# CRITICAL: Historical should be completely empty
stats_historical
---
historical_count: 0
historical_key_bytes: 0
historical_value_bytes: 0

# Third update: should drop version 2
set a=value3_longer version=4
---
ok

drop a keep_last_versions=1 version=5
---
ok

stats_current
---
current_count: 1
current_key_bytes: 11
current_value_bytes: 13

stats_historical
---
historical_count: 0
historical_key_bytes: 0
historical_value_bytes: 0

# Fourth update: should drop version 3
set a=v4 version=6
---
ok

drop a keep_last_versions=1 version=7
---
ok

stats_current
---
current_count: 1
current_key_bytes: 11
current_value_bytes: 2

# Verify all three historical fields remain zero together
stats_historical
---
historical_count: 0
historical_key_bytes: 0
historical_value_bytes: 0

# Verify totals
stats_totals
---
total_count: 1
current_bytes: 13
historical_bytes: 0
total_bytes: 13

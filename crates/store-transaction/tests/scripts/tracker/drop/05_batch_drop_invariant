# Test batch drop with multiple versions of varying sizes
# This verifies that the batch drop fix correctly aggregates all dropped
# versions' bytes, ensuring count, key_bytes, and value_bytes stay synchronized

# Create multiple versions with varying value sizes
set a=v1 version=1
---
ok

set a=v2_longer version=2
---
ok

set a=v3_even_longer version=3
---
ok

set a=v4 version=4
---
ok

# Verify historical accumulation
# v1 (2 bytes), v2_longer (9 bytes), v3_even_longer (14 bytes) = 25 bytes total
stats_historical
---
historical_count: 3
historical_key_bytes: 27
historical_value_bytes: 25

stats_current
---
current_count: 1
current_key_bytes: 9
current_value_bytes: 2

# Drop all but the latest version
# This tests the batch drop path in multi.rs
drop a keep_last_versions=1 version=5
---
ok

# CRITICAL: All three historical fields must be zero together
# This is the core invariant that the batch drop fix ensures
stats_historical
---
historical_count: 0
historical_key_bytes: 0
historical_value_bytes: 0

# Current should remain unchanged
stats_current
---
current_count: 1
current_key_bytes: 9
current_value_bytes: 2

# Verify overall totals
stats_totals
---
total_count: 1
current_bytes: 11
historical_bytes: 0
total_bytes: 11

# Copyright (c) reifydb.com 2025
# This file is licensed under the AGPL-3.0-or-later, see license.md file

# Tests that saturating_sub prevents underflow.
# Even with aggressive drops, counts stay >= 0.

# Create versions
set a=1 version=1
---
ok

set a=2 version=2
---
ok

set a=3 version=3
---
ok

# Historical has 2 entries: 2 Ã— versioned_key=9 = 18 key bytes, values "1" + "2" = 2 value bytes
stats_historical
---
historical_count: 2
historical_key_bytes: 22
historical_value_bytes: 2

# Drop all versions (this includes current!)
drop a version=4
---
ok

# Drop removes historical versions; current (version 3) remains.
# Historical should be 0, current should still have 1 entry.
stats
---
current_count: 1
current_key_bytes: 11
current_value_bytes: 1
historical_count: 0
historical_key_bytes: 0
historical_value_bytes: 0
cdc_count: 3
cdc_key_bytes: 3
cdc_value_bytes: 228
total_bytes: 12

# Additional drop on empty should not cause underflow
drop a version=5
---
ok

stats
---
current_count: 1
current_key_bytes: 11
current_value_bytes: 1
historical_count: 0
historical_key_bytes: 0
historical_value_bytes: 0
cdc_count: 3
cdc_key_bytes: 3
cdc_value_bytes: 228
total_bytes: 12

# Copyright (c) reifydb.com 2025
# This file is licensed under the AGPL-3.0-or-later, see license.md file

# Test expression evaluation order
# Operator precedence and parentheses

(command 'create schema test;')
command 'create table test.source { 
  id: int4,
  a: int4,
  b: int4,
  c: int4
}'
---
> +----------+----------+-----------+
> |  schema  |  table   |  created  |
> +----------+----------+-----------+
> |   test   |  source  |   true    |
> +----------+----------+-----------+
> 

command 'create deferred view test.precedence { 
  id: int4,
  no_parens: int4,
  left_assoc: int4,
  right_assoc: int4,
  mixed_ops: int4,
  force_order: int4
} with {
  from test.source
  map { 
    id,
    a + b * c as no_parens,
    a - b - c as left_assoc,
    a * b / c as right_assoc,
    a + b * c - a / c as mixed_ops,
    ((a + b) * c) - (a / (c + 1)) as force_order
  }
}'
---
> +----------+--------------+-----------+
> |  schema  |     view     |  created  |
> +----------+--------------+-----------+
> |   test   |  precedence  |   true    |
> +----------+--------------+-----------+
> 

# Insert test data
command 'from [
  {id: 1, a: 12, b: 4, c: 3},
  {id: 2, a: 20, b: 5, c: 2},
  {id: 3, a: 15, b: 3, c: 5}
] insert test.source'
---
> +----------+----------+------------+
> |  schema  |  table   |  inserted  |
> +----------+----------+------------+
> |   test   |  source  |     3      |
> +----------+----------+------------+
> 

wait 10

# Should show different results based on evaluation order
command 'from test.precedence'
---
> +------+-------------+--------------+---------------+-------------+---------------+
> |  id  |  no_parens  |  left_assoc  |  right_assoc  |  mixed_ops  |  force_order  |
> +------+-------------+--------------+---------------+-------------+---------------+
> |  3   |     30      |      7       |       9       |     27      |      88       |
> |  2   |     30      |      13      |      50       |     20      |      44       |
> |  1   |     24      |      5       |      16       |     20      |      45       |
> +------+-------------+--------------+---------------+-------------+---------------+
> 

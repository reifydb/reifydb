# Copyright (c) reifydb.com 2025
# This file is licensed under the AGPL-3.0-or-later, see license.md file

# Test complex computed columns
# Multiple operations in single expression

(command 'create schema test;')
command 'create table test.source { 
  product: utf8,
  quantity: int4,
  unit_price: float8,
  discount_pct: float8
}'
---
> +----------+----------+-----------+
> |  schema  |  table   |  created  |
> +----------+----------+-----------+
> |   test   |  source  |   true    |
> +----------+----------+-----------+
> 

command 'create deferred view test.order_summary { 
  product: utf8,
  quantity: int4,
  base_total: float8,
  discount_amount: float8,
  final_price: float8,
  price_per_unit_after_discount: float8
} with {
  from test.source
  map { 
    product,
    quantity,
    quantity * unit_price as base_total,
    quantity * unit_price * discount_pct as discount_amount,
    quantity * unit_price * (1 - discount_pct) as final_price,
    unit_price * (1 - discount_pct) as price_per_unit_after_discount
  }
}'
---
> +----------+-----------------+-----------+
> |  schema  |      view       |  created  |
> +----------+-----------------+-----------+
> |   test   |  order_summary  |   true    |
> +----------+-----------------+-----------+
> 

# Insert test data
command 'from [
  {product: "Widget", quantity: 10, unit_price: 25.50, discount_pct: 0.10},
  {product: "Gadget", quantity: 5, unit_price: 50.00, discount_pct: 0.15},
  {product: "Tool", quantity: 3, unit_price: 75.25, discount_pct: 0.20}
] insert test.source'
---
> +----------+----------+------------+
> |  schema  |  table   |  inserted  |
> +----------+----------+------------+
> |   test   |  source  |     3      |
> +----------+----------+------------+
> 

await

# Should show complex computed values
command 'from test.order_summary'
---
> +-----------+------------+--------------+----------------------+----------------------+---------------------------------+
> |  product  |  quantity  |  base_total  |   discount_amount    |     final_price      |  price_per_unit_after_discount  |
> +-----------+------------+--------------+----------------------+----------------------+---------------------------------+
> |   Tool    |     3      |    225.75    |  45.150000000000006  |  180.60000000000002  |              60.2               |
> |  Gadget   |     5      |     250      |         37.5         |        212.5         |              42.5               |
> |  Widget   |     10     |     255      |         25.5         |        229.5         |              22.95              |
> +-----------+------------+--------------+----------------------+----------------------+---------------------------------+
> 

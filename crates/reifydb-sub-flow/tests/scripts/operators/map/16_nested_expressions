# Copyright (c) reifydb.com 2025
# This file is licensed under the AGPL-3.0-or-later, see license.md file

# Test nested/complex expressions
# Multiple levels of parentheses and operations

(command 'create schema test;')
command 'create table test.source { 
  id: int4,
  a: int4,
  b: int4,
  c: int4
}'
---
> +----------+----------+-----------+
> |  schema  |  table   |  created  |
> +----------+----------+-----------+
> |   test   |  source  |   true    |
> +----------+----------+-----------+
> 

command 'create deferred view test.nested_calc { 
  id: int4,
  simple: int4,
  nested: int4,
  complex: int4,
  very_nested: int4
} with {
  from test.source
  map { 
    id,
    a + b * c as simple,
    (a + b) * c as nested,
    ((a + b) * (c - 1)) / 2 as complex,
    (((a * 2) + (b * 3)) * ((c + 1) / 2)) - 10 as very_nested
  }
}'
---
> +----------+---------------+-----------+
> |  schema  |     view      |  created  |
> +----------+---------------+-----------+
> |   test   |  nested_calc  |   true    |
> +----------+---------------+-----------+
> 

# Insert test data
command 'from [
  {id: 1, a: 5, b: 3, c: 4},
  {id: 2, a: 10, b: 2, c: 6},
  {id: 3, a: 8, b: 4, c: 2}
] insert test.source'
---
> +----------+----------+------------+
> |  schema  |  table   |  inserted  |
> +----------+----------+------------+
> |   test   |  source  |     3      |
> +----------+----------+------------+
> 

wait 10

# Should show nested expression results
command 'from test.nested_calc'
---
> +------+----------+----------+-----------+---------------+
> |  id  |  simple  |  nested  |  complex  |  very_nested  |
> +------+----------+----------+-----------+---------------+
> |  3   |    16    |    24    |     6     |      18       |
> |  2   |    22    |    72    |    30     |      68       |
> |  1   |    17    |    32    |    12     |      28       |
> +------+----------+----------+-----------+---------------+
> 

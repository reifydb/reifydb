name: test-suite

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  discover-suites:
    runs-on: ubuntu-latest
    outputs:
      suites: ${{ steps.discover.outputs.suites }}
    steps:
      - name: ⬇️ Checkout private test suite repo
        run: |
          git clone https://x-access-token:${{ secrets.GH_REPO_PAT }}@github.com/reifydb/testsuite.git testsuite
      
      - name: 🔍 Discover test suites
        id: discover
        run: |
          cd testsuite
          # Find all directories that contain a Cargo.toml (test suites)
          suites=$(find . -maxdepth 2 -type f -name "Cargo.toml" -exec dirname {} \; | sed 's|^\./||' | grep -v '^\.$' | sort | jq -R -s -c 'split("\n")[:-1]')
          echo "Found test suites: $suites"
          echo "suites=$suites" >> $GITHUB_OUTPUT

  test:
    needs: discover-suites
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    strategy:
      matrix:
        suite: ${{ fromJson(needs.discover-suites.outputs.suites) }}

    steps:
      - name: ⬇️ Checkout main repo
        uses: actions/checkout@v4
        with:
          path: reifydb

      - name: ⬇️ Checkout private test suite repo
        run: |
          git clone https://x-access-token:${{ secrets.GH_REPO_PAT }}@github.com/reifydb/testsuite.git testsuite

      - name: 🛠️ Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: 🧪 Run test suite
        run: |
          echo "▶ Running ${{ matrix.suite }}"
          export CARGO_TARGET_DIR=$(realpath reifydb/target)
          cd testsuite/${{ matrix.suite }}
          ~/.cargo/bin/cargo test
